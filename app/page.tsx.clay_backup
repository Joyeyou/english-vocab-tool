'use client';

import { useState, useRef } from 'react';
import { Search, BookOpen, History, Download, Printer, Trash2 } from 'lucide-react';
import WordCard from '@/components/WordCard';
import { WordData } from '@/types/word';
import { storageUtils } from '@/lib/utils';
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

export default function Home() {
  const [inputValue, setInputValue] = useState('');
  const [wordsList, setWordsList] = useState<WordData[]>([]);
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState<'search' | 'history' | 'favorites'>('search');
  const printRef = useRef<HTMLDivElement>(null);

  // æŸ¥è¯¢å•è¯ï¼ˆæ¸è¿›å¼åŠ è½½ï¼šå…ˆæ˜¾ç¤ºåŸºç¡€ä¿¡æ¯ï¼Œå†å¼‚æ­¥åŠ è½½ç¿»è¯‘ï¼‰
  const handleSearch = async () => {
    if (!inputValue.trim()) return;

    setLoading(true);
    const words = inputValue
      .split(/[\s,ï¼Œã€]+/)
      .map((w) => w.trim())
      .filter((w) => w.length > 0);

    try {
      const results: WordData[] = [];

      // ç¬¬ä¸€æ­¥ï¼šå¿«é€Ÿè·å–åŸºç¡€æ•°æ®ï¼ˆè·³è¿‡ç¿»è¯‘ï¼‰
      for (const word of words) {
        const response = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ word, skipTranslation: true }),
        });

        if (response.ok) {
          const wordData = await response.json();
          results.push(wordData);
        }
      }

      // ç«‹å³æ˜¾ç¤ºåŸºç¡€æ•°æ®
      setWordsList(results);
      setActiveTab('search');
      setLoading(false);

      // ç¬¬äºŒæ­¥ï¼šå¼‚æ­¥åŠ è½½ç¿»è¯‘ï¼ˆåå°è¿›è¡Œï¼‰
      console.log('åŸºç¡€æ•°æ®å·²æ˜¾ç¤ºï¼Œå¼€å§‹åŠ è½½ç¿»è¯‘...');
      for (let i = 0; i < words.length; i++) {
        const word = words[i];

        // å¼‚æ­¥è·å–å¸¦ç¿»è¯‘çš„å®Œæ•´æ•°æ®
        fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ word, skipTranslation: false }),
        })
          .then((response) => response.json())
          .then((translatedData) => {
            // æ›´æ–°å¯¹åº”å•è¯çš„æ•°æ®
            setWordsList((prevList) => {
              const newList = [...prevList];
              newList[i] = translatedData;
              return newList;
            });

            // ä¿å­˜åˆ°å†å²è®°å½•
            storageUtils.saveToHistory(translatedData);

            console.log(`${word} ç¿»è¯‘åŠ è½½å®Œæˆ`);
          })
          .catch((error) => {
            console.error(`${word} ç¿»è¯‘åŠ è½½å¤±è´¥:`, error);
          });
      }
    } catch (error) {
      console.error('æŸ¥è¯¢å¤±è´¥:', error);
      alert('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      setLoading(false);
    }
  };

  // åŠ è½½å†å²è®°å½•
  const loadHistory = () => {
    const history = storageUtils.getHistory();
    setWordsList(history);
    setActiveTab('history');
  };

  // åŠ è½½ç”Ÿè¯æœ¬
  const loadFavorites = () => {
    const favorites = storageUtils.getFavorites();
    setWordsList(favorites);
    setActiveTab('favorites');
  };

  // å¯¼å‡ºPDF
  const exportToPDF = async () => {
    if (!printRef.current || wordsList.length === 0) {
      alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹');
      return;
    }

    try {
      // æ˜¾ç¤ºåŠ è½½æç¤º
      alert('æ­£åœ¨ç”ŸæˆPDFï¼Œè¯·ç¨å€™...\nè¿™å¯èƒ½éœ€è¦10-20ç§’');
      console.log('å¼€å§‹ç”ŸæˆPDF...');

      // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡å’Œå­—ä½“åŠ è½½
      await new Promise(resolve => setTimeout(resolve, 500));

      const canvas = await html2canvas(printRef.current, {
        scale: 2, // é«˜è´¨é‡
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        allowTaint: false,
        removeContainer: true,
        imageTimeout: 15000,
        windowWidth: printRef.current.scrollWidth,
        windowHeight: printRef.current.scrollHeight,
      });

      console.log('Canvasç”ŸæˆæˆåŠŸï¼Œå¼€å§‹è½¬æ¢ä¸ºPDF...');

      const imgWidth = 210; // A4å®½åº¦(mm)
      const pageHeight = 297; // A4é«˜åº¦(mm)
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;

      const pdf = new jsPDF('p', 'mm', 'a4');
      let position = 0;

      // ä½¿ç”¨PNGæ ¼å¼ä¿è¯è´¨é‡
      const imgData = canvas.toDataURL('image/png');

      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft >= 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      const filename = `å•è¯å¡ç‰‡-${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.pdf`;
      pdf.save(filename);

      console.log('PDFå¯¼å‡ºæˆåŠŸ:', filename);
      alert('PDFå¯¼å‡ºæˆåŠŸï¼');
    } catch (error) {
      console.error('å¯¼å‡ºPDFå¤±è´¥:', error);
      const errorMsg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      alert(`å¯¼å‡ºå¤±è´¥: ${errorMsg}\n\nè¯·å°è¯•ï¼š\n1. ç¡®ä¿æ‰€æœ‰ç¿»è¯‘å·²åŠ è½½å®Œæˆ\n2. å‡å°‘å•è¯æ•°é‡åé‡è¯•\n3. ä½¿ç”¨æµè§ˆå™¨çš„æ‰“å°åŠŸèƒ½ï¼ˆCtrl+Pï¼‰`);
    }
  };

  // æ‰“å°
  const handlePrint = () => {
    window.print();
  };

  // æ¸…ç©ºå½“å‰åˆ—è¡¨
  const handleClear = () => {
    if (activeTab === 'search') {
      setWordsList([]);
    } else if (activeTab === 'history') {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
        storageUtils.clearHistory();
        setWordsList([]);
      }
    } else if (activeTab === 'favorites') {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç”Ÿè¯æœ¬å—ï¼Ÿ')) {
        storageUtils.clearFavorites();
        setWordsList([]);
      }
    }
  };

  return (
    <div className="min-h-screen" style={{ background: 'var(--color-bg-primary)' }}>
      {/* é¡¶éƒ¨å¯¼èˆªæ  - Claymorphism Style */}
      <header className="clay-card mx-4 mt-4 mb-6">
        <div className="container mx-auto px-6 py-5">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="p-3 rounded-2xl" style={{
                background: 'linear-gradient(135deg, #4F46E5 0%, #6366F1 100%)',
                boxShadow: 'var(--shadow-clay-sm)',
              }}>
                <BookOpen className="w-8 h-8 text-white" />
              </div>
              <div>
                <h1 className="text-3xl font-heading font-bold" style={{ color: 'var(--color-text-primary)' }}>
                  è‹±è¯­å•è¯å­¦ä¹ å·¥å…·
                </h1>
                <p className="text-sm mt-1" style={{ color: 'var(--color-text-muted)' }}>
                  2027æ˜¥è€ƒå¤‡è€ƒåŠ©æ‰‹ ğŸ“š
                </p>
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* ä¸»è¦å†…å®¹åŒº */}
      <main className="container mx-auto px-4 py-8 max-w-6xl">
        {/* æœç´¢åŒºåŸŸ - Claymorphism Style */}
        <div className="clay-card p-8 mb-8">
          <div className="flex flex-col sm:flex-row gap-4">
            <input
              type="text"
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && !loading && handleSearch()}
              placeholder="è¾“å…¥å•è¯ï¼Œå¤šä¸ªå•è¯ç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”... ğŸ”"
              className="clay-input flex-1 px-6 py-4 text-lg font-body"
              style={{ color: 'var(--color-text-primary)' }}
              disabled={loading}
            />
            <button
              onClick={handleSearch}
              disabled={loading}
              className="clay-btn clay-btn-primary px-8 py-4 text-lg flex items-center justify-center gap-3 min-w-[140px]"
            >
              {loading ? (
                <>
                  <div className="animate-spin-clay w-5 h-5 border-3 border-white border-t-transparent rounded-full" />
                  æŸ¥è¯¢ä¸­...
                </>
              ) : (
                <>
                  <Search className="w-5 h-5" />
                  æŸ¥è¯¢
                </>
              )}
            </button>
          </div>
        </div>

        {/* æ ‡ç­¾é¡µå’Œæ“ä½œæŒ‰é’® - Claymorphism Style */}
        <div className="flex flex-wrap items-center justify-between gap-6 mb-8">
          <div className="flex flex-wrap gap-3">
            <button
              onClick={() => setActiveTab('search')}
              className={`clay-btn px-5 py-3 font-heading text-base flex items-center gap-2 transition-clay ${
                activeTab === 'search'
                  ? 'clay-btn-primary'
                  : ''
              }`}
              style={activeTab !== 'search' ? {
                background: 'white',
                borderColor: 'rgba(129, 140, 248, 0.3)',
                color: 'var(--color-text-primary)',
              } : {}}
            >
              <Search className="w-4 h-4" />
              æŸ¥è¯¢ç»“æœ
            </button>
            <button
              onClick={loadHistory}
              className={`clay-btn px-5 py-3 font-heading text-base flex items-center gap-2 transition-clay ${
                activeTab === 'history'
                  ? 'clay-btn-primary'
                  : ''
              }`}
              style={activeTab !== 'history' ? {
                background: 'white',
                borderColor: 'rgba(129, 140, 248, 0.3)',
                color: 'var(--color-text-primary)',
              } : {}}
            >
              <History className="w-4 h-4" />
              å†å²è®°å½•
            </button>
            <button
              onClick={loadFavorites}
              className={`clay-btn px-5 py-3 font-heading text-base flex items-center gap-2 transition-clay ${
                activeTab === 'favorites'
                  ? 'clay-btn-primary'
                  : ''
              }`}
              style={activeTab !== 'favorites' ? {
                background: 'white',
                borderColor: 'rgba(129, 140, 248, 0.3)',
                color: 'var(--color-text-primary)',
              } : {}}
            >
              <BookOpen className="w-4 h-4" />
              ç”Ÿè¯æœ¬
            </button>
          </div>

          {wordsList.length > 0 && (
            <div className="flex flex-wrap gap-3">
              <button
                onClick={exportToPDF}
                className="clay-btn clay-btn-success px-5 py-3 text-base flex items-center gap-2"
              >
                <Download className="w-4 h-4" />
                å¯¼å‡ºPDF
              </button>
              <button
                onClick={handlePrint}
                className="clay-btn px-5 py-3 text-base flex items-center gap-2"
                style={{
                  background: 'linear-gradient(135deg, #A855F7 0%, #9333EA 100%)',
                  borderColor: '#7C3AED',
                  color: 'white',
                }}
              >
                <Printer className="w-4 h-4" />
                æ‰“å°
              </button>
              <button
                onClick={handleClear}
                className="clay-btn px-5 py-3 text-base flex items-center gap-2"
                style={{
                  background: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)',
                  borderColor: '#B91C1C',
                  color: 'white',
                }}
              >
                <Trash2 className="w-4 h-4" />
                æ¸…ç©º
              </button>
            </div>
          )}
        </div>

        {/* å•è¯å¡ç‰‡åˆ—è¡¨ */}
        <div ref={printRef} className="print:bg-white">
          {wordsList.length === 0 ? (
            <div className="clay-card text-center py-20">
              <div className="inline-block p-6 rounded-3xl mb-6" style={{
                background: 'linear-gradient(135deg, #818CF8 0%, #6366F1 100%)',
                boxShadow: 'var(--shadow-clay-md)',
              }}>
                <BookOpen className="w-16 h-16 text-white" />
              </div>
              <p className="text-xl font-heading font-semibold mb-2" style={{ color: 'var(--color-text-primary)' }}>
                {activeTab === 'search' && 'è¾“å…¥å•è¯å¼€å§‹æŸ¥è¯¢'}
                {activeTab === 'history' && 'æš‚æ— å†å²è®°å½•'}
                {activeTab === 'favorites' && 'æš‚æ— æ”¶è—çš„å•è¯'}
              </p>
              <p className="text-base" style={{ color: 'var(--color-text-muted)' }}>
                {activeTab === 'search' && 'æ”¯æŒæ‰¹é‡æŸ¥è¯¢ï¼Œç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”å¤šä¸ªå•è¯'}
                {activeTab === 'history' && 'æŸ¥è¯¢è¿‡çš„å•è¯ä¼šè‡ªåŠ¨ä¿å­˜åœ¨è¿™é‡Œ'}
                {activeTab === 'favorites' && 'ç‚¹å‡»å•è¯å¡ç‰‡ä¸Šçš„æ˜Ÿæ˜Ÿå›¾æ ‡æ”¶è—å•è¯'}
              </p>
            </div>
          ) : (
            <div className="space-y-4">
              {wordsList.map((wordData, index) => (
                <WordCard
                  key={`${wordData.word}-${index}`}
                  wordData={wordData}
                  onFavoriteChange={() => {
                    if (activeTab === 'favorites') {
                      loadFavorites();
                    }
                  }}
                />
              ))}
            </div>
          )}
        </div>
      </main>

      {/* é¡µè„š - Claymorphism Style */}
      <footer className="clay-card mx-4 mb-4 mt-8">
        <div className="container mx-auto px-6 py-6 max-w-6xl">
          <div className="flex flex-col md:flex-row items-center justify-between gap-6">
            <div className="text-center md:text-left">
              <p className="text-2xl font-heading font-bold mb-2" style={{
                background: 'linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                backgroundClip: 'text',
              }}>
                ğŸ¯ å†²åˆº2027æ˜¥è€ƒè‹±è¯­ 135+ ğŸ’ª
              </p>
              <p className="text-sm font-body" style={{ color: 'var(--color-text-muted)' }}>
                åšæŒæ¯å¤©å­¦ä¹ ï¼Œæ¢¦æƒ³ç»ˆä¼šå®ç°ï¼âœ¨
              </p>
            </div>
            <div className="text-center md:text-right">
              <div className="clay-badge mb-2" style={{
                background: 'linear-gradient(135deg, #6366F1 0%, #818CF8 100%)',
                borderColor: '#4F46E5',
                color: 'white',
              }}>
                v1.0.0
              </div>
              <p className="text-xs font-body" style={{ color: 'var(--color-text-muted)' }}>
                åŒAPIå¹¶è¡Œç¿»è¯‘ Â· æ™ºèƒ½çŸ­è¯­æå–
              </p>
            </div>
          </div>
        </div>
      </footer>

      {/* æ‰“å°æ ·å¼ */}
      <style jsx global>{`
        @media print {
          @page {
            margin: 1cm;
            size: A4;
          }

          /* éšè—ä¸éœ€è¦æ‰“å°çš„å…ƒç´  */
          header,
          footer,
          button,
          input {
            display: none !important;
          }

          body {
            font-size: 9pt !important;
            line-height: 1.4 !important;
            color: #000 !important;
          }

          /* æ‰“å°å®¹å™¨ */
          .print\\:bg-white {
            background: white !important;
          }

          /* å¡ç‰‡å¸ƒå±€ï¼šæ¨ªå‘å·¦å³åˆ†æ  */
          .print\\:bg-white > div {
            page-break-inside: avoid;
            margin-bottom: 0.4cm !important;
            padding: 0.4cm !important;
            box-shadow: none !important;
            border: 1.5px solid #333 !important;
            border-radius: 0 !important;
          }

          /* å¼ºåˆ¶å¡ç‰‡å†…éƒ¨æ¨ªå‘å¸ƒå±€ */
          .print\\:bg-white > div > div {
            display: flex !important;
            flex-direction: row !important;
          }

          /* å·¦ä¾§ï¼šå•è¯åŒºåŸŸï¼ˆ30%å®½åº¦ï¼‰ */
          .print\\:bg-white > div > div > div:first-child {
            width: 30% !important;
            border-right: 1px solid #ddd !important;
            padding: 0.3cm !important;
            background: #f8f9fa !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: flex-start !important;
            align-items: flex-start !important;
          }

          /* å³ä¾§ï¼šå†…å®¹åŒºåŸŸï¼ˆ70%å®½åº¦ï¼‰ */
          .print\\:bg-white > div > div > div:last-child {
            width: 70% !important;
            padding: 0.3cm !important;
          }

          /* å•è¯æ ‡é¢˜ */
          h2 {
            font-size: 16pt !important;
            font-weight: bold !important;
            margin: 0 0 0.1cm 0 !important;
            color: #000 !important;
          }

          /* éŸ³æ ‡ */
          .print\\:bg-white h2 + div p {
            font-size: 9pt !important;
            color: #555 !important;
            margin: 0 0 0.2cm 0 !important;
          }

          /* è¯æ±‡ç­‰çº§æ ‡ç­¾ */
          .rounded-md {
            padding: 2px 4px !important;
            font-size: 7pt !important;
            margin: 2px !important;
          }

          /* å³ä¾§åŒºåŸŸæ ‡é¢˜ */
          h3 {
            font-size: 9pt !important;
            font-weight: bold !important;
            margin: 0.1cm 0 0.05cm 0 !important;
            text-transform: none !important;
          }

          /* æ®µè½ */
          p {
            font-size: 8.5pt !important;
            margin: 0 0 0.1cm 0 !important;
            line-height: 1.4 !important;
          }

          /* å†…å®¹åŒºå— */
          .mb-6, .mb-4, .mb-3, .mb-2 {
            margin-bottom: 0.15cm !important;
          }

          .p-6, .p-4, .p-3 {
            padding: 0.15cm !important;
          }

          /* ä¾‹å¥ã€çŸ­è¯­ã€åŒä¹‰è¯åŒºåŸŸ */
          .bg-purple-50,
          .bg-green-50,
          .bg-orange-50,
          .bg-blue-50,
          .bg-indigo-50 {
            background: #f5f5f5 !important;
            padding: 0.15cm !important;
            margin: 0.05cm 0 !important;
            border-left: 2px solid #666 !important;
          }

          /* ä¾‹å¥å•ç‹¬åŒºå— */
          .space-y-3 > div {
            margin-bottom: 0.1cm !important;
          }

          /* éšè—æ‰€æœ‰å›¾æ ‡å’Œè£…é¥°æ€§å…ƒç´  */
          svg {
            display: none !important;
          }

          /* éšè—å‘éŸ³æŒ‰é’®ç­‰ */
          .print\\:bg-white button {
            display: none !important;
          }

          /* ç¿»è¯‘æ–‡æœ¬æ ·å¼ */
          .text-gray-600,
          .text-gray-700,
          .text-gray-800 {
            color: #333 !important;
          }

          /* å¼ºè°ƒè‰²è°ƒæ•´ä¸ºé»‘ç™½æ‰“å°å‹å¥½ */
          .text-blue-600,
          .text-green-700,
          .text-orange-900,
          .text-purple-600 {
            color: #000 !important;
          }
        }
      `}</style>
    </div>
  );
}
